# Docker & Nginx Advanced Setup

–≠—Ç–æ—Ç —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É Docker-—Å–±–æ—Ä–∫–∏ (multi-stage build), CI/CD –ø–∞–π–ø–ª–∞–π–Ω–∞ —á–µ—Ä–µ–∑ GitHub Actions –∏ –≥–ª—É–±–æ–∫—É—é –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é Nginx —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤ –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

## üê≥ Docker –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏

–í –ø—Ä–æ–µ–∫—Ç–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **Multi-stage build** (`dockerfile`):

1.  **Build Stage (oven/bun:1-alpine)**:
    *   –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–º —Å–ª–æ–µ.
    *   –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å `package.json`/`bun.lock` (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫—ç—à —Å–ª–æ–µ–≤).
2.  **Production Stage (nginx:stable-alpine)**:
    *   –§–∏–Ω–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–∑ –≤–µ—Å–∏—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω–æ (—Ç–æ–ª—å–∫–æ Nginx + —Å—Ç–∞—Ç–∏–∫–∞).
    *   –ù–∏–∫–∞–∫–∏—Ö `node_modules` –∏ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –∫–æ–¥–∞ –≤ –ø—Ä–æ–¥–µ.

## üöÄ CI/CD (GitHub Actions)

–ù–∞—Å—Ç—Ä–æ–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –¥–µ–ø–ª–æ–π –ø—Ä–∏ –ø—É—à–µ –≤ `master` (`.github/workflows/deploy.yml`):
1.  **Build**: –°–±–æ—Ä–∫–∞ –æ–±—Ä–∞–∑–∞ –∏ –ø—É—à –≤ GitHub Container Registry (GHCR).
2.  **Deploy**: –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø–æ SSH –∫ —Å–µ—Ä–≤–µ—Ä—É, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ —Å `restart: always` –∏ –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –æ–±—Ä–∞–∑–æ–≤ (`prune`).

## üß™ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Nginx

–í –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–Ω–∞ –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ) –≤—Å—Ç—Ä–æ–µ–Ω–∞ —É–¥–æ–±–Ω–∞—è –ø–∞–Ω–µ–ª—å –Ω–∞–≤–∏–≥–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤—Å–µ—Ö –ø—Ä–∞–≤–∏–ª –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏.

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ç–µ—Å—Ç–æ–≤

#### 1. –°—Ç—Ä–æ–≥–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ (`=`) - –°–∞–º—ã–π –≤—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç
–ó–∞–ø—Ä–æ—Å –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ, —Ñ–∞–π–ª –¥–∞–∂–µ –Ω–µ –∏—â–µ—Ç—Å—è –Ω–∞ –¥–∏—Å–∫–µ (–æ—Ç–≤–µ—Ç –∑–∞–¥–∞–Ω –ø—Ä—è–º–æ –≤ –∫–æ–Ω—Ñ–∏–≥–µ).

*   **URL:** [http://localhost:8080/static/exact.html](http://localhost:8080/static/exact.html)
*   **–û–∂–∏–¥–∞–Ω–∏–µ:** –¢–µ–∫—Å—Ç "This is EXACT match. Highest priority."
*   **–ö–æ–Ω—Ñ–∏–≥:** `location = /static/exact.html { return 200 ... }`

#### 2. –ü—Ä–µ—Ñ–∏–∫—Å —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º (`^~`) - –ë–ª–æ–∫–∏—Ä—É–µ—Ç Regex
–ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å —ç—Ç–æ–≥–æ –ø—É—Ç–∏, Nginx **–ø—Ä–µ–∫—Ä–∞—â–∞–µ—Ç** –ø–æ–∏—Å–∫ —Ä–µ–≥—É–ª—è—Ä–Ω—ã—Ö –≤—ã—Ä–∞–∂–µ–Ω–∏–π.

*   **URL:** [http://localhost:8080/static/priority/](http://localhost:8080/static/priority/)
*   **–û–∂–∏–¥–∞–Ω–∏–µ:** –†–æ–∑–æ–≤–∞—è HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ "Priority Prefix Match".
*   **–õ–æ–≥–∏–∫–∞:** Nginx –Ω–∞—Ö–æ–¥–∏—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ, –≤–∏–¥–∏—Ç `^~` –∏ —Å—Ä–∞–∑—É –æ—Ç–¥–∞–µ—Ç —Ñ–∞–π–ª, –∏–≥–Ω–æ—Ä–∏—Ä—É—è –ª—é–±—ã–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∞–≤–∏–ª–∞.

#### 3. –†–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ (`~*`) - –ü–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ—Ç –æ–±—ã—á–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –∫–∞—Ä—Ç–∏–Ω–æ–∫. "–ü–æ–±–µ–∂–¥–∞–µ—Ç" –æ–±—ã—á–Ω—ã–µ –ø—Ä–µ—Ñ–∏–∫—Å—ã (—Å–º. –ø—É–Ω–∫—Ç 4).

*   **URL:** [http://localhost:8080/static/image.png](http://localhost:8080/static/image.png)
*   **–û–∂–∏–¥–∞–Ω–∏–µ:** –û—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–∏–Ω–∫–∞ (React Logo). –í –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –æ—Ç–≤–µ—Ç–∞ (`DevTools -> Network`) –µ—Å—Ç—å `Cache-Control: public, immutable`.
*   **–õ–æ–≥–∏–∫–∞:** –ó–∞–ø—Ä–æ—Å `/static/image.png` –ø–æ–¥—Ö–æ–¥–∏—Ç –ø–æ–¥ –ø—Ä–µ—Ñ–∏–∫—Å `/static/`, –Ω–æ Nginx –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –∏—Å–∫–∞—Ç—å Regex. –û–Ω –Ω–∞—Ö–æ–¥–∏—Ç `~* \.png$` –∏ –≤—ã–±–∏—Ä–∞–µ—Ç –µ–≥–æ, —Ç–∞–∫ –∫–∞–∫ Regex –≤–∞–∂–Ω–µ–µ –æ–±—ã—á–Ω–æ–≥–æ –ø—Ä–µ—Ñ–∏–∫—Å–∞.

#### 4. –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –ø—Ä–µ—Ñ–∏–∫—Å (`/`) + Alias
–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è, –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –±–æ–ª–µ–µ –≤–∞–∂–Ω–æ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.

*   **URL:** [http://localhost:8080/static/](http://localhost:8080/static/)
*   **–û–∂–∏–¥–∞–Ω–∏–µ:** –ì–æ–ª—É–±–∞—è HTML-—Å—Ç—Ä–∞–Ω–∏—Ü–∞ "Standard Prefix Match" —Å –∫–∞—Ä—Ç–∏–Ω–∫–æ–π.
*   **–õ–æ–≥–∏–∫–∞:**
    1. –ú—ã –∑–∞—Ö–æ–¥–∏–º –Ω–∞ `/static/`.
    2. Nginx –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `alias` –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç —Ñ–∞–π–ª –∏–∑ –ø–∞–ø–∫–∏ `public/static-demo/`.
    3. **–í–∞–∂–Ω–æ:** –ù–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞ `<img src="/static/image.png">`. –ö–æ–≥–¥–∞ –±—Ä–∞—É–∑–µ—Ä –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç –µ—ë, —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –ø—É–Ω–∫—Ç 3 (Regex), –∏ –∫–∞—Ä—Ç–∏–Ω–∫–∞ –æ—Ç–¥–∞–µ—Ç—Å—è –∏–∑ *–¥—Ä—É–≥–æ–π* –ø–∞–ø–∫–∏ (–∫–æ—Ä–Ω–µ–≤–æ–π), –∞ –Ω–µ –∏–∑ `static-demo`. –≠—Ç–æ –¥–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —á—Ç–æ Regex –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–µ–µ Alias-–∞.

*   **File Descriptors**: –£–≤–µ–ª–∏—á–µ–Ω –ª–∏–º–∏—Ç `worker_rlimit_nofile` (65535) –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ç—ã—Å—è—á —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.
*   **Keepalive Upstream**: –î–ª—è –ø—Ä–æ–∫—Å–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ GitHub API –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –±–ª–æ–∫ `upstream` —Å `keepalive`. –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å TCP-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –∫ –±—ç–∫–µ–Ω–¥—É, —ç–∫–æ–Ω–æ–º—è —Ä–µ—Å—É—Ä—Å—ã –Ω–∞ SSL-—Ä—É–∫–æ–ø–æ–∂–∞—Ç–∏—è—Ö.
*   **Sendfile/Tcp_nopush**: –í–∫–ª—é—á–µ–Ω—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–π –æ—Ç–¥–∞—á–∏ —Å—Ç–∞—Ç–∏–∫–∏ –Ω–∞–ø—Ä—è–º—É—é —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏ —è–¥—Ä–∞ Linux.
*   **Security Headers**: –î–æ–±–∞–≤–ª–µ–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (`X-Frame-Options`, `Content-Security-Policy` –∏ –¥—Ä.).



### üåê API Proxy (GitHub)
Nginx –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ –ø—Ä–æ–∫—Å–∏ –¥–ª—è GitHub API —Å –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–µ–π —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (keepalive).
*   **URL:** [http://localhost:8080/api/users/octocat](http://localhost:8080/api/users/octocat)
*   **–û–∂–∏–¥–∞–Ω–∏–µ:** JSON-–æ—Ç–≤–µ—Ç –æ—Ç GitHub API —Å –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
*   **–õ–æ–≥–∏–∫–∞:** Nginx –ø–æ–¥–º–µ–Ω—è–µ—Ç –∑–∞–≥–æ–ª–æ–≤–∫–∏ (`Host`, `SNI`) –∏ –ø–µ—Ä–µ—Å—ã–ª–∞–µ—Ç –∑–∞–ø—Ä–æ—Å –Ω–∞ `api.github.com`, –∏—Å–ø–æ–ª—å–∑—É—è –ø—É–ª –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

# curl —Å –≤—ã–≤–æ–¥–æ–º –≤—Ä–µ–º–µ–Ω–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è (time_connect) –∏ –æ–±—â–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (time_total)
for i in {1..5}; do 
  curl -o /dev/null -s -w "Connect: %{time_connect}s | Total: %{time_total}s\n" http://localhost:8080/api/zen
done
Connect: 0.000156s | Total: 0.427117s
Connect: 0.000250s | Total: 0.132240s
Connect: 0.000148s | Total: 0.116531s
Connect: 0.000205s | Total: 0.131573s
Connect: 0.000311s | Total: 0.126226s

–ï—Å–ª–∏ Total –≤—Ä–µ–º—è —Å—Ç–∞–±–∏–ª—å–Ω–æ –Ω–∏–∑–∫–æ–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 0.2s - 0.4s), –∞ Connect (–¥–æ –≤–∞—à–µ–≥–æ Nginx) –º–≥–Ω–æ–≤–µ–Ω–Ω—ã–π ‚Äî –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç. –û—Å–Ω–æ–≤–Ω–æ–π –≤—ã–∏–≥—Ä—ã—à –∑–¥–µ—Å—å —Å–∫—Ä—ã—Ç "–≤–Ω—É—Ç—Ä–∏" Nginx (–º–µ–∂–¥—É –Ω–∏–º –∏ GitHub), –ø–æ—ç—Ç–æ–º—É —Å–Ω–∞—Ä—É–∂–∏ –≤—ã —É–≤–∏–¥–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ –±–æ–ª–µ–µ –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç –≤ —Ü–µ–ª–æ–º.
