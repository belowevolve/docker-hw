worker_processes auto;
worker_rlimit_nofile 65535; # Увеличиваем лимит файловых дескрипторов
events {
    worker_connections 16384; # Макс. соединений = worker_processes * worker_connections
    multi_accept on; # Принимать сразу несколько соединений
    use epoll; # Оптимальный метод обработки событий для Linux
}
http {
    include       /etc/nginx/mime.types;
    default_type  application/octet-stream;

    keepalive_timeout 65;
    keepalive_requests 100;

    # Оптимизация передачи файлов
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;

    # Upstream для Github API (оптимизация соединений)
    upstream github_backend {
        server api.github.com:443;
        keepalive 32;
    }

    server {
        listen 80;
        server_name localhost;


        # Сжатие gzip: значительно ускоряет загрузку текстовых файлов (js, css, html)
        gzip on;
        gzip_vary on;
        gzip_proxied any;
        gzip_comp_level 6;
        gzip_types text/plain text/css text/xml application/json application/javascript application/rss+xml application/atom+xml image/svg+xml;

        # Защитные заголовки (Security Headers)
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-XSS-Protection "1; mode=block";
        add_header X-Content-Type-Options "nosniff";
        add_header Referrer-Policy "no-referrer-when-downgrade";
        add_header Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'; frame-ancestors 'self';";

        # Основная локация для SPA (Single Page Application)
        location / {
            root /usr/share/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }

        # Кэширование статики (JS, CSS, изображения)
        # Эти файлы имеют хэши в названиях (благодаря Vite), поэтому их можно кэшировать "навечно"
        location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|otf)$ {
            root /usr/share/nginx/html;
            expires 1y;
            add_header Cache-Control "public, immutable";
            access_log off;
        }

        # Проксирование запросов к API GitHub
        location /api/ {
            rewrite ^/api/(.*) /$1 break;
            proxy_pass https://github_backend;
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host api.github.com;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_ssl_server_name on;

            # Увеличение буферов (GitHub может возвращать большие заголовки)
            proxy_buffer_size 128k;
            proxy_buffers 4 256k;
            proxy_busy_buffers_size 256k;

            # Лимиты по времени (Timeout)
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;

        }

        # 1. СТРОГОЕ СОВПАДЕНИЕ (=) - Самый высокий приоритет
        location = /static/exact.html {
            return 200 "This is EXACT match. Highest priority.\n";
        }

        # 2. Префикс с приоритетом (^~)
        # http://localhost:8080/static/priority/ -> Возвращает index.html из папки public/static/priority
        location ^~ /static/priority/ {
            root /usr/share/nginx/html; # Путь будет: /usr/share/nginx/html/static/priority/
            add_header X-Match-Type "Priority Prefix (^~)";
        }

        # 3. Регулярное выражение (~*)
        # http://localhost:8080/static/image.png -> Возвращает картинку с долгим кэшем
        location ~* \.(jpg|jpeg|png|gif|ico)$ {
            root /usr/share/nginx/html;
            expires 1y;
            add_header X-Match-Type "Regex (~*)";
        }

        # 4. Обычный префикс (/)
        # http://localhost:8080/static/ -> Возвращает index.html из папки public/static-demo (через alias)
        location /static/ {
            # Alias заменяет /static/ на путь к папке
            alias /usr/share/nginx/html/static-demo/;
            index index.html;
            add_header X-Match-Type "Standard Prefix (Alias)";
        }
    }
}
